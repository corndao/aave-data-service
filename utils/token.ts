import { ethers } from "ethers";
import { providerRPC } from "./helper";

interface TokenBalance {
  token: string,
  balance: string,
  decimals: number,
}

const abi = `[{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"}]`;

export async function fetchTokenBalances(account: string, tokenAddresses: string[]): Promise<TokenBalance[]> {
  const provider = new ethers.providers.JsonRpcProvider(
    {
      // `skipFetchSetup` is required for Cloudflare Worker according to the issue: 
      // https://github.com/ethers-io/ethers.js/issues/1886#issuecomment-1063531514
      skipFetchSetup: true,
      url: providerRPC,
    }
  );

  const balanceResults: Promise<string>[] = tokenAddresses.map(address => {
    const token = new ethers.Contract(address, abi, provider);
    return token.balanceOf(account)
      .then((bal: any) => bal.toString());
  });

  const decimalsResults: Promise<number>[] = tokenAddresses.map(address => {
    const token = new ethers.Contract(address, abi, provider);
    return token.decimals();
  });

  const balances = await Promise.all(balanceResults);
  const decimals = await Promise.all(decimalsResults);
  
  const results: TokenBalance[] = [];
  for (let i = 0; i < tokenAddresses.length; i++) {
    results.push({
      token: tokenAddresses[i],
      balance: balances[i],
      decimals: decimals[i],
    });
  }

  return results;
}

fetchTokenBalances('0xF7175dC7D7D42Cd41fD7d19f10adE1EA84D99D0C', ['0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9'])
  .then(console.log)
